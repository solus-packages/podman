From 16763c3df0eaf3b6e5b7883c60b59f051f811cda Mon Sep 17 00:00:00 2001
From: Lokesh Mandvekar <lsm5@fedoraproject.org>
Date: Tue, 22 Sep 2020 16:24:23 -0400
Subject: [PATCH] fix build with varlink

also add a cirrus task for building binaries with varlink.
From: Chris Evich <cevich@redhat.com>

Signed-off-by: Lokesh Mandvekar <lsm5@fedoraproject.org>
---
 .cirrus.yml              | 1 +
 pkg/varlinkapi/system.go | 8 +++++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/.cirrus.yml b/.cirrus.yml
index 8b1036d7ca..d2a8cb6605 100644
--- a/.cirrus.yml
+++ b/.cirrus.yml
@@ -123,6 +123,7 @@ gating_task:
         # N/B: need 'clean' so some committed files are re-generated.
         - '/usr/local/bin/entrypoint.sh clean podman-remote |& ${TIMESTAMP}'
         - '/usr/local/bin/entrypoint.sh clean podman xref_helpmsgs_manpages BUILDTAGS="exclude_graphdriver_devicemapper selinux seccomp" |& ${TIMESTAMP}'
+        - '/usr/local/bin/entrypoint.sh clean BUILDTAGS="varlink" binaries |& ${TIMESTAMP}'
         - '/usr/local/bin/entrypoint.sh local-cross |& ${TIMESTAMP}'
 
     # Verify some aspects of ci/related scripts
diff --git a/pkg/varlinkapi/system.go b/pkg/varlinkapi/system.go
index 9e4db2611a..e5c766a6d6 100644
--- a/pkg/varlinkapi/system.go
+++ b/pkg/varlinkapi/system.go
@@ -7,6 +7,7 @@ import (
 	"fmt"
 	"os"
 	goruntime "runtime"
+	"strconv"
 	"time"
 
 	"github.com/containers/image/v5/pkg/sysregistriesv2"
@@ -22,13 +23,18 @@ func (i *VarlinkAPI) GetVersion(call iopodman.VarlinkCall) error {
 		return err
 	}
 
+	int64APIVersion, err := strconv.ParseInt(versionInfo.APIVersion, 10, 64)
+	if err != nil {
+		return err
+	}
+
 	return call.ReplyGetVersion(
 		versionInfo.Version,
 		versionInfo.GoVersion,
 		versionInfo.GitCommit,
 		time.Unix(versionInfo.Built, 0).Format(time.RFC3339),
 		versionInfo.OsArch,
-		versionInfo.APIVersion,
+		int64APIVersion,
 	)
 }
